function fillProjectSelect(e,a){var t=$(e);t.find("option").remove(),$("<option>").val("").text("").appendTo(t),$.each(a,function(e,a){$("<option>").val(a.projectId).text(a.name).appendTo(t)})}function customerChangeHandler(){var e=$(this).val();""!==e&&$.ajax({type:"POST",url:customerProjectUrl,data:{customerId:e},cache:!1,success:function(e){fillProjectSelect("#projectId",e)}})}function dateChangeHandler(e,a){var t=moment(a.val(),"YYYY-MM-DD");if(!dateIsValid(a.val())&&!confirm(confirmBookingNonBusiness)){var r=t.subtract(1,"days").format("YYYY-MM-DD");a.val(r).change()}}function dateIsValid(e){var a=moment(e,"YYYY-MM-DD"),t=jQuery.inArray(a.day(),workingDays)>=0,r=jQuery.inArray(e,holidays)>=0;return t&&!r}function startDateChangeHandler(e,a){var t=$(e).val();""===$(a).val()&&$(a).val(t)}function initDateField(e){jQuery(e).datetimepicker({timepicker:!1,format:"Y-m-d",formatDate:"Y-m-d",dayOfWeekStart:firstDayOfWeek,onSelectDate:dateChangeHandler})}function lockForm(){$("#startDate").attr("disabled","disabled"),$("#endDate").attr("disabled","disabled"),$("#startTime").attr("disabled","disabled"),$("#endTime").attr("disabled","disabled"),$("#hours").attr("disabled","disabled"),$("#minutes").attr("disabled","disabled"),$("#customerId").attr("disabled","disabled"),$("#projectId").attr("disabled","disabled")}function unlockForm(){$("#startDate").removeAttr("disabled"),$("#endDate").removeAttr("disabled"),$("#startTime").removeAttr("disabled"),$("#endTime").removeAttr("disabled"),$("#hours").removeAttr("disabled"),$("#minutes").removeAttr("disabled"),$("#customerId").removeAttr("disabled"),$("#projectId").removeAttr("disabled")}function setBookableWorkShift(e){var a=moment(e.minTime,"H:m"),t=moment(e.maxTime,"H:m");workingDays=e.dow,holidays=e.holidays,jQuery("#minStartTime").val(a.format("HH:mm:ss")),jQuery("#maxEndTime").val(t.format("HH:mm:ss")),jQuery("#workingDays").val(workingDays.join())}function ajaxSaveBooking(){$.ajax({type:"POST",url:saveBookingUrl,data:$(".form-booking-plugin").serialize(),cache:!1,success:successBookingForm,dataType:"json"})}function successBookingForm(e){if(e.success)$(location).attr("href",viewBookingsUrl);else{$(".form-booking-plugin").find(".validation-error").remove(),$(".form-booking-plugin").find(".error-field").removeClass("error-field");for(var a=e.errors.length,t=0;t<a;t++){var r=$("#"+e.errors[t].field);$("<span>").addClass("validation-error").addClass(e.errors[t].field).attr("generated","true").text(e.errors[t].message).insertAfter(r),r.addClass("error-field")}}}var workingDays=[],holidays=[];jQuery(document).ready(function(){$("#bookableId").change(function(){var e=$(this).val(),a=moment().clone().startOf("year").format("YYYY-MM-DD"),t=moment().clone().endOf("year").format("YYYY-MM-DD");""!==e&&$.ajax({type:"POST",url:bookableWorkShiftsUrl,data:{bookableId:e,start:a,end:t},cache:!1,success:function(e){unlockForm(),setBookableWorkShift(e)}})}),$("#customerId").change(customerChangeHandler),$("#startDate").change(function(){startDateChangeHandler("#startDate","#endDate")}),initDateField("#startDate"),initDateField("#endDate"),$("#btnSave").click(function(){var e=dateIsValid($("#startDate").val()),a=dateIsValid($("#endDate").val());e&&a?ajaxSaveBooking():confirm(confirmBookingNonBusiness)&&ajaxSaveBooking()}),""!==$("#bookableId").val()?$("#bookableId").change():lockForm(),""!==$("#customerId").val()&&$("#customerId").change()});
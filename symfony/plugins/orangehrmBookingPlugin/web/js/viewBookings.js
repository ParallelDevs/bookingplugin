function fillProjectSelect(e,o){var n=$(e);n.find("option").remove(),$("<option>").val("").text("").appendTo(n),$.each(o,function(e,o){$("<option>").val(o.projectId).text(o.name).appendTo(n)})}function customerChangeHandler(){var e=$(this).val();""!==e&&$.ajax({type:"POST",url:customerProjectUrl,data:{customerId:e},cache:!1,success:function(e){fillProjectSelect("#projectId",e)}})}function dateChangeHandler(e,o){var n=moment(o.val(),"YYYY-MM-DD");if(!dateIsValid(o.val())&&!confirm(confirmBookingNonBusiness)){var a=n.subtract(1,"days").format("YYYY-MM-DD");o.val(a).change()}}function dateIsValid(e){var o=moment(e,"YYYY-MM-DD"),n=jQuery.inArray(o.day(),workingDays)>=0,a=jQuery.inArray(e,holidays)>=0;return n&&!a}function startDateChangeHandler(e,o){var n=$(e).val();""===$(o).val()&&$(o).val(n)}function initDateField(e){jQuery(e).datetimepicker({timepicker:!1,format:"Y-m-d",formatDate:"Y-m-d",dayOfWeekStart:firstDayOfWeek,onSelectDate:dateChangeHandler})}function initModalFields(){initDateField("#startDate"),initDateField("#endDate")}function ajaxLoadNewBooking(){$.ajax({type:"POST",url:bookingFormUrl,data:{bookableId:bookableId,bookableName:bookableName,startDate:startDate,endDate:endDate,minStartTime:minStartTime,maxEndTime:maxEndTime,workingDays:workingDays.join()},success:function(e){$("#addBooking").find(".modal-body").html(e),initModalFields(),$("#addBooking").modal("show")}})}function ajaxLoadEditBooking(e){$.ajax({type:"POST",url:bookingFormUrl,data:{bookingId:bookingId,bookableId:bookableId,startDate:startDate,endDate:endDate,minStartTime:minStartTime,maxEndTime:maxEndTime,workingDays:workingDays.join()},success:function(e){$("#editBooking").find(".modal-body").html(e),initModalFields(),$("#editBooking").modal("show")},fail:function(){revertCalendar(e)}})}function ajaxSaveBooking(){$.ajax({type:"POST",url:saveBookingUrl,data:$(".form-booking-plugin").serialize(),cache:!1,success:successBookingForm,dataType:"json"})}function ajaxDeleteBooking(){bookingId=$("#bookingId").val(),$.ajax({type:"POST",url:deleteBookingUrl,data:{bookingId:bookingId},cache:!1,success:successBookingForm,dataType:"json"})}function successBookingForm(e){if(e.success)$(activeModalId).modal("hide");else for(var o=e.errors.length,n=0;n<o;n++){var a=$("#"+e.errors[n].field);$("<span>").addClass("validation-error").addClass(e.errors[n].field).attr("generated","true").text(e.errors[n].message).insertAfter(a),a.addClass("error-field")}}function refreshBookings(){$("#calendar").fullCalendar("refetchEvents"),holidayEvent=null}function resourceErrorHandler(){}function resourceRenderHandler(e,o,n){e.isActive?o.addClass("booking-resource-active"):(o.addClass("booking-resource-inactive"),o.tipTip({content:inactiveResourceTooltip}),jQuery.isEmptyObject(n)||n.addClass("fc-nonbusiness"))}function eventErrorHandler(){}function eventRenderHandler(e,o,n){if(e.isHoliday)o.tipTip({content:holidayLabel+" "+e.title}),o.addClass("fc-nonbusiness booking-holiday");else if(o.tipTip({content:e.customerName+" - "+e.title}),n)switch(n.type){case"timelineMonth":o.find(".fc-time").text(e.duration+"h p/d"),o.find(".fc-title").remove();break;case"timelineWeek":o.find(".fc-title").text(e.duration+"h p/d");break;case"timelineDay":break;case"month":case"basicWeek":o.find(".fc-time").text(e.duration+"h p/d");break;case"agendaWeek":o.find(".fc-time").remove()}}function eventMouseoverHandler(e,o,n){$(this).addClass("fc-highlighted")}function eventMouseoutHandler(e,o,n){$(this).removeClass("fc-highlighted")}function loadVarsFromEvent(e){var o=$("#calendar").fullCalendar("getResourceById",e.resourceId);bookingId=e.id,startDate=e.start.format("YYYY-MM-DD"),endDate=e.end.format("YYYY-MM-DD"),bookableId=o.id,bookableName=o.title,minStartTime=o.businessHours[0].start,maxEndTime=o.businessHours[0].end,workingDays=o.businessHours[0].dow}function revertCalendar(e){jQuery.isFunction(e)?e():refreshBookings(),holidayEvent=null}function addBookingConfirmBusinessDays(e,o,n){var a=$("#calendar").fullCalendar("getResourceById",n),i=jQuery.inArray(e.day(),a.businessHours[0].dow)>=0,t=jQuery.inArray(o.day(),a.businessHours[0].dow)>=0,r=!(!holidayEvent||!e.isSame(holidayEvent.start,"day")),d=!(!holidayEvent||!o.isSame(holidayEvent.start,"day")),s="";i?t?(r||d)&&(s=confirmBookingHoliday):s=confirmEndBookingNonBusiness:s=confirmStartBookingNonBusiness,!r&&!d&&i&&t?ajaxLoadNewBooking():confirm(s)?ajaxLoadNewBooking():($("#calendar").fullCalendar("unselect"),holidayEvent=null)}function editBookingConfirmNonBusinessDays(e,o){var n=e.start,a=e.end,i=$("#calendar").fullCalendar("getResourceById",e.resourceId),t=jQuery.inArray(n.day(),i.businessHours[0].dow)>=0,r=jQuery.inArray(a.day(),i.businessHours[0].dow)>=0,d=!(!holidayEvent||!n.isSame(holidayEvent.start,"day")),s=!(!holidayEvent||!a.isSame(holidayEvent.start,"day")),l="";t?r?(d||s)&&(l=confirmBookingHoliday):l=confirmEndBookingNonBusiness:l=confirmStartBookingNonBusiness,!d&&!s&&t&&r?ajaxLoadEditBooking(o):confirm(l)?ajaxLoadEditBooking(o):revertCalendar(o)}function eventAfterRenderHandler(e,o,n){if(e.isHoliday){var a=e.start.format("YYYY-MM-DD");jQuery.inArray(a,holidays)<0&&holidays.push(a)}e.editable&&o.bind("dblclick",function(){eventDblClickHandler(e)})}function eventResizeHandler(e,o,n,a,i,t){loadVarsFromEvent(e),editBookingConfirmNonBusinessDays(e,n)}function eventDropHandler(e,o,n,a,i,t,r,d){0!==o.asDays()&&(loadVarsFromEvent(e),editBookingConfirmNonBusinessDays(e,i))}function eventDblClickHandler(e){loadVarsFromEvent(e),ajaxLoadEditBooking(refreshBookings)}function eventOverlapHandler(e,o){return holidayEvent=e.isHoliday?e:null,!0}function selectHandler(e,o,n,a,i){bookableId=i.id,bookableName=i.title,minStartTime=i.businessHours[0].start,maxEndTime=i.businessHours[0].end,workingDays=i.businessHours[0].dow,startDate=e.format("YYYY-MM-DD");var t=o.subtract(1,"days");t.isBefore(startDate)&&(t=e),endDate=t.format("YYYY-MM-DD"),addBookingConfirmBusinessDays(e,t,i.id)}function selectAllowHandler(e){var o=$("#calendar").fullCalendar("getResourceById",e.resourceId);return!(o&&!o.isActive)}function selectOverlapHandler(e){return holidayEvent=e.isHoliday?e:null,!0}var workingDays=[],holidays=[],activeModalId="";jQuery(document).ready(function(){$("#addBooking, #editBooking").on("hide.bs.modal",function(){$(this).find(".modal-body").empty(),refreshBookings()}),$("#addBooking, #editBooking").on("change","#customerId",customerChangeHandler),$("#addBooking, #editBooking").on("change","#startDate",function(){startDateChangeHandler("#startDate","#endDate")}),$("#addBooking").on("click",".btn.save",function(){activeModalId="#addBooking",$("#addBooking .form-booking-plugin").find(".validation-error").remove(),$("#addBooking .form-booking-plugin").find(".error-field").removeClass("error-field"),$("#addBooking .form-booking-plugin input").removeClass("error-field"),ajaxSaveBooking()}),$("#editBooking").on("click",".btn.save",function(){activeModalId="#editBooking",$("#editBooking .form-booking-plugin").find(".validation-error").remove(),$("#editBooking .form-booking-plugin").find(".error-field").removeClass("error-field"),$("#editBooking .form-booking-plugin input").removeClass("error-field"),ajaxSaveBooking()}),$("#editBooking").on("click",".btn.delete",function(){activeModalId="#editBooking",confirm(confirmDeleteBooking)&&ajaxDeleteBooking()})});var bookingId="",bookableId="",bookableName="",startDate="",endDate="",minStartTime="",maxEndTime="",holidayEvent=null;$(function(){$("#calendar").fullCalendar({schedulerLicenseKey:"GPL-My-Project-Is-Open-Source",now:moment().startOf("day"),selectable:!0,selectHelper:!0,editable:!0,eventResourceEditable:!1,aspectRatio:4,firstDay:firstDayOfWeek,slotEventOverlap:!1,minTime:calendarMinTime,maxTime:calendarMaxTime,header:{left:"prev,next today",center:"title",right:"timelineDay,timelineWeek,timelineMonth"},defaultView:"timelineMonth",resourceAreaWidth:"25%",resourceLabelText:bookableResourceTitle,resources:{url:bookableResourcesUrl,type:"POST",error:resourceErrorHandler},events:{url:bookingResourcesUrl,data:{mode:"timeline"},type:"POST",error:eventErrorHandler},resourceRender:resourceRenderHandler,eventRender:eventRenderHandler,eventAfterRender:eventAfterRenderHandler,eventMouseover:eventMouseoverHandler,eventMouseout:eventMouseoutHandler,eventResize:eventResizeHandler,eventDrop:eventDropHandler,eventOverlap:eventOverlapHandler,select:selectHandler,selectAllow:selectAllowHandler,selectOverlap:selectOverlapHandler})});
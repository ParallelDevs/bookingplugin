function fillProjectSelect(e,a){var o=$(e);o.find("option").remove(),$("<option>").val("").text("").appendTo(o),$.each(a,function(e,a){$("<option>").val(a.projectId).text(a.name).appendTo(o)})}function customerChangeHandler(){var e=$(this).val();""!==e&&$.ajax({type:"POST",url:customerProjectUrl,data:{customerId:e},cache:!1,success:function(e){fillProjectSelect("#projectId",e)}})}function startDateChangeHandler(e,a){var o=$(e).val();""===$(a).val()&&$(a).val(o)}function initDateField(e){jQuery(e).datetimepicker({timepicker:!1,format:"Y-m-d",formatDate:"Y-m-d",dayOfWeekStart:firstDayOfWeek})}function initModalFields(){initDateField("#startDate"),initDateField("#endDate")}function ajaxLoadNewBooking(){$.ajax({type:"POST",url:bookingFormUrl,data:{bookableId:bookableId,bookableName:bookableName,startDate:startDate,endDate:endDate,minStartTime:minStartTime,maxEndTime:maxEndTime},success:function(e){$("#addBooking").find(".modal-body").html(e),initModalFields(),$("#addBooking").modal("show")}})}function ajaxLoadEditBooking(e){$.ajax({type:"POST",url:bookingFormUrl,data:{bookingId:bookingId,bookableId:bookableId,startDate:startDate,endDate:endDate,minStartTime:minStartTime,maxEndTime:maxEndTime},success:function(e){$("#editBooking").find(".modal-body").html(e),initModalFields(),$("#editBooking").modal("show")},fail:function(){e()}})}function ajaxSaveBooking(){$.ajax({type:"POST",url:saveBookingUrl,data:$(".form-booking-plugin").serialize(),cache:!1,success:successBookingForm,dataType:"json"})}function successBookingForm(e){if(e.success)$(activeModalId).modal("hide");else for(var a=e.errors.length,o=0;o<a;o++)console.log(e.errors[o])}function refreshBookings(){$("#calendar").fullCalendar("refetchEvents"),holidayOverlap=!1}function resourceErrorHandler(){}function resourceRenderHandler(e,a,o){e.isActive?a.addClass("booking-resource-active"):(a.addClass("booking-resource-inactive"),a.tipTip({content:inactiveResourceTooltip}),jQuery.isEmptyObject(o)||o.addClass("fc-nonbusiness"))}function eventErrorHandler(){}function eventRenderHandler(e,a,o){if(e.isHoliday)a.tipTip({content:holidayLabel+" "+e.title}),a.addClass("fc-nonbusiness booking-holiday");else if(a.tipTip({content:e.customerName+" - "+e.title}),o)switch(o.type){case"timelineMonth":a.find(".fc-time").text(e.duration+"h p/d"),a.find(".fc-title").remove();break;case"timelineWeek":a.find(".fc-title").text(e.duration+"h p/d");break;case"timelineDay":break;case"month":a.find(".fc-time").text(e.duration+"h p/d");break;case"agendaWeek":a.find(".fc-time").remove()}}function eventMouseoverHandler(e,a,o){$(this).addClass("fc-highlighted")}function eventMouseoutHandler(e,a,o){$(this).removeClass("fc-highlighted")}function loadVarsFromEvent(e){bookingId=e.id,startDate=e.start.format("YYYY-MM-DD"),endDate=e.end.format("YYYY-MM-DD");var a=$("#calendar").fullCalendar("getResourceById",e.resourceId);a&&(bookableId=a.id,bookableName=a.title,minStartTime=a.businessHours[0].start,maxEndTime=a.businessHours[0].end)}function editBookingConfirmNonBusinessDays(e,a){var o=e.start,n=e.end,t=$("#calendar").fullCalendar("getResourceById",e.resourceId);!holidayOverlap&&jQuery.inArray(o.day(),t.businessHours[0].dow)>=0&&jQuery.inArray(n.day(),t.businessHours[0].dow)>=0?ajaxLoadEditBooking(a):holidayOverlap||jQuery.inArray(o.day(),t.businessHours[0].dow)<0?confirm(confirmStartBookingNonBusiness)?ajaxLoadEditBooking(a):(a(),holidayOverlap=!1):(holidayOverlap||jQuery.inArray(n.day(),t.businessHours[0].dow)<0)&&(confirm(confirmEndBookingNonBusiness)?ajaxLoadEditBooking(a):(a(),holidayOverlap=!1))}function eventAfterRenderHandler(e,a,o){e.editable&&a.bind("dblclick",function(){eventDblClickHandler(e)})}function eventResizeHandler(e,a,o,n,t,i){loadVarsFromEvent(e),editBookingConfirmNonBusinessDays(e,o)}function eventDropHandler(e,a,o,n,t,i,r,d){0!==a.asDays()&&(loadVarsFromEvent(e),editBookingConfirmNonBusinessDays(e,t))}function eventDblClickHandler(e){loadVarsFromEvent(e),ajaxLoadEditBooking(refreshBookings)}function selectHandler(e,a,o,n,t){t&&(bookableId=t.id,bookableName=t.title,minStartTime=t.businessHours[0].start,maxEndTime=t.businessHours[0].end),startDate=e.format("YYYY-MM-DD");var i=a.subtract(1,"days");i.isBefore(startDate)&&(i=e),endDate=i.format("YYYY-MM-DD"),!holidayOverlap&&jQuery.inArray(e.day(),t.businessHours[0].dow)>=0&&jQuery.inArray(i.day(),t.businessHours[0].dow)>=0?ajaxLoadNewBooking():holidayOverlap||jQuery.inArray(e.day(),t.businessHours[0].dow)<0?confirm(confirmStartBookingNonBusiness)?ajaxLoadNewBooking():($("#calendar").fullCalendar("unselect"),holidayOverlap=!1):(holidayOverlap||jQuery.inArray(i.day(),t.businessHours[0].dow)<0)&&(confirm(confirmEndBookingNonBusiness)?ajaxLoadNewBooking():($("#calendar").fullCalendar("unselect"),holidayOverlap=!1))}function selectAllowHandler(e){var a=$("#calendar").fullCalendar("getResourceById",e.resourceId);return!(a&&!a.isActive)}function selectOverlapHandler(e){return holidayOverlap=!!e.isHoliday,!0}var activeModalId="";jQuery(document).ready(function(){$("#addBooking, #editBooking").on("hide.bs.modal",function(){$(this).find(".modal-body").empty(),refreshBookings(),holidayOverlap=!1}),$("#addBooking, #editBooking").on("change","#customerId",customerChangeHandler),$("#addBooking, #editBooking").on("change","#startDate",function(){startDateChangeHandler("#startDate","#endDate")}),$("#addBooking").on("click",".btn.save",function(){activeModalId="#addBooking",ajaxSaveBooking()}),$("#editBooking").on("click",".btn.save",function(){activeModalId="#editBooking",ajaxSaveBooking()})});var bookingId="",bookableId="",bookableName="",startDate="",endDate="",minStartTime="",maxEndTime="",holidayOverlap=!1;$(function(){$("#calendar").fullCalendar({schedulerLicenseKey:"GPL-My-Project-Is-Open-Source",now:moment().startOf("day"),selectable:!0,selectHelper:!0,editable:!0,eventResourceEditable:!1,aspectRatio:4,firstDay:firstDayOfWeek,slotEventOverlap:!1,minTime:calendarMinTime,maxTime:calendarMaxTime,header:{left:"prev,next today",center:"title",right:"timelineDay,timelineWeek,timelineMonth"},defaultView:"timelineMonth",resourceAreaWidth:"25%",resourceLabelText:bookableResourceTitle,resources:{url:bookableResourcesUrl,type:"POST",error:resourceErrorHandler},events:{url:bookingResourcesUrl,data:{mode:"timeline"},type:"POST",error:eventErrorHandler},resourceRender:resourceRenderHandler,eventRender:eventRenderHandler,eventAfterRender:eventAfterRenderHandler,eventMouseover:eventMouseoverHandler,eventMouseout:eventMouseoutHandler,eventResize:eventResizeHandler,eventDrop:eventDropHandler,select:selectHandler,selectAllow:selectAllowHandler,selectOverlap:selectOverlapHandler})});